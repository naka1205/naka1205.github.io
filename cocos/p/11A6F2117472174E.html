<!DOCTYPE HTML>
<html lang=""> 
<head>
    <meta charset="UTF-8">
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <title>弹窗管理 · PKBOOK</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="description" content="我们已经知道怎样制作、加载、显示界面。但cocos没有提供一个弹窗管理模块，对于一个多人合作的项目，没有统一的管理，界面层级容易混乱。作为主程，在项目开始就应该处理好这些问题，将弹窗划分为不同的层次，不同类型的信息显示在不同的层中。下面将讲解怎样设计弹窗堆栈。">
    <meta name="keywords" content="CocosCreator 教程">
    <meta name="generator" content="PKBook">
    <link rel="stylesheet" href="https://naka1205.github.io/cocos/assets/css/style.css">
    <link rel="stylesheet" href="https://naka1205.github.io/cocos/assets/css/search.css">
    <link rel="stylesheet" href="https://naka1205.github.io/cocos/assets/css/ebook.css">
    <link rel="stylesheet" href="https://naka1205.github.io/cocos/assets/css/website.css">
    <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/styles/github.min.css" rel="stylesheet">
    <meta name="HandheldFriendly" content="true" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://naka1205.github.io/cocos/assets/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="https://naka1205.github.io/cocos/assets/images/favicon.ico" type="image/x-icon">
</head>
<body>
<div class="book">
    <div class="book-summary">
        <div id="book-search-input" role="search">
            <input type="text" placeholder="输入关键词搜索" />
        </div>
        <nav role="navigation">
    <ul class="summary">
        <li><a href="https://naka1205.github.io/cocos/index.html" target="blank" class="header">关于我们</a></li>
        <li class="divider"></li>
                <li class="header">教程</li>
                        <li class="chapter " data-level="1.1" data-path="https://naka1205.github.io/cocos/p/60DA9CE88BF3343E.html"><a href="https://naka1205.github.io/cocos/p/60DA9CE88BF3343E.html">初识creator</a></li>
                        <li class="chapter " data-level="1.2" data-path="https://naka1205.github.io/cocos/p/30A5A7449E53FF36.html"><a href="https://naka1205.github.io/cocos/p/30A5A7449E53FF36.html">资源管理</a></li>
                        <li class="chapter  active " data-level="1.3" data-path="https://naka1205.github.io/cocos/p/11A6F2117472174E.html"><a href="https://naka1205.github.io/cocos/p/11A6F2117472174E.html">弹窗管理</a></li>
                        <li class="chapter " data-level="1.4" data-path="https://naka1205.github.io/cocos/p/BFFA75863D9BB58A.html"><a href="https://naka1205.github.io/cocos/p/BFFA75863D9BB58A.html">网络通信</a></li>
                        <li class="chapter " data-level="1.5" data-path="https://naka1205.github.io/cocos/p/37322E7BA0648835.html"><a href="https://naka1205.github.io/cocos/p/37322E7BA0648835.html">日志系统</a></li>
                        <li class="chapter " data-level="1.6" data-path="https://naka1205.github.io/cocos/p/748D14A6DC9142BB.html"><a href="https://naka1205.github.io/cocos/p/748D14A6DC9142BB.html">消息分发</a></li>
                        <li class="chapter " data-level="1.7" data-path="https://naka1205.github.io/cocos/p/DE657CA8EE77BE83.html"><a href="https://naka1205.github.io/cocos/p/DE657CA8EE77BE83.html">MVC架构</a></li>
                        <li class="chapter " data-level="1.8" data-path="https://naka1205.github.io/cocos/p/E593CAA756CFDE55.html"><a href="https://naka1205.github.io/cocos/p/E593CAA756CFDE55.html">代码结构</a></li>
                        <li class="chapter " data-level="1.9" data-path="https://naka1205.github.io/cocos/p/22AC2C263EC626A0.html"><a href="https://naka1205.github.io/cocos/p/22AC2C263EC626A0.html">瓦片地图</a></li>
                        <li class="chapter " data-level="1.10" data-path="https://naka1205.github.io/cocos/p/D44D258BFB70E858.html"><a href="https://naka1205.github.io/cocos/p/D44D258BFB70E858.html"> A*寻路</a></li>
                        <li class="chapter " data-level="1.11" data-path="https://naka1205.github.io/cocos/p/FB97038B212BD9C7.html"><a href="https://naka1205.github.io/cocos/p/FB97038B212BD9C7.html">有限状态机和行为树</a></li>
                    <li class="divider"></li>
                <li><a href="https://github.com/naka1205/pkbook" target="blank" class="gitbook-link">Published with PKBook</a></li>
    </ul>
</nav>
    </div>
    
    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
                <h1><i class="fa fa-circle-o-notch fa-spin"></i><a href="https://naka1205.github.io/cocos/p/11A6F2117472174E.html">弹窗管理</a></h1>
            </div>
            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                    <div id="book-search-results">
                        <div class="search-noresults">
                            <section class="normal markdown-section">
                                <h2 id="%E5%BC%B9%E7%AA%97%E7%AE%A1%E7%90%86" name="%E5%BC%B9%E7%AA%97%E7%AE%A1%E7%90%86">弹窗管理</h2>
<p>我们已经知道怎样制作、加载、显示界面。但<code>cocos</code>没有提供一个弹窗管理模块，对于一个多人合作的项目，没有统一的管理，界面层级容易混乱。作为主程，在项目开始就应该处理好这些问题，将弹窗划分为不同的层次，不同类型的信息显示在不同的层中。下面将讲解怎样设计弹窗堆栈。</p>
<p>一般地，从下向上，我会将弹窗划分为以下层：</p>
<ol>
<li>内容层，展示游戏相关的信息界面。</li>
<li><code>tips</code>层，显示提示性信息界面，例如获得物品的浮窗、网络异常的提示。</li>
<li>新手引导层，主要显示新手引导的手指、新手提示文本框等。</li>
<li><code>alert</code>层，主要显示系统级的信息、错误，例如断网、被踢下线。</li>
<li><code>loading</code>层，显示加载动画。</li>
</ol>
<p><img src="http://files.kmei.org/1551863878915.jpg" alt="弹窗划分" title="弹窗划分" /></p>
<p>具体怎样实现？弹窗通常有统一的动画，所以定义一个界面逻辑的基类<code>ViewCtrl</code>，定义一些通用的属性和方法。每个层中可能同时存在多个界面，我把每个层做成组<code>ViewGroup</code>。再写一个类<code>PopupCtrl</code>，对界面分层，并对外提供编程接口。</p>
<p>先来说说<code>ViewCtrl</code>这个类，继承自<code>cc.Component</code>，这样我们写的<code>ViewCtrl</code>子类就可以挂载到<code>prefab</code>的节点上。定义两个<code>boolean</code>属性：<code>hasMask</code>、<code>touchOutClose</code>，用于控制是否有灰色半透明遮罩，和是否点击弹窗外关闭。后面在介绍<code>ViewGroup</code>时会介绍怎样实现这两个功能。</p>
<p><code>cc.Component</code>本身有<code>onEnable</code>，<code>onDisable</code>两个生命周期方法，但我们希望同屏不出现太多弹窗，弹出新弹窗时隐藏上一个弹窗，这会导致这两个方法频繁调用。对于打开界面时的刷新，在界面放到堆栈时回调更合适。同理对重用的界面的重置，在界面移出堆栈时回调重置。可以在<code>ViewCtrl</code>定义<code>onAddToStack和onRemoveFromStack</code>两个生命周期方法，在<code>ViewGroup</code>里在合适的时机触发，后面会介绍。再添加两个方法，<code>onPlayShowAni</code>，<code>onPlayHideAni</code>，在这里可以实现统一的弹窗动画。子类的特殊显示和关闭动画由子类重写这两个方法实现。这两个方法也由<code>ViewGroup</code>在合适的时机触发。</p>
<pre><code class="javascript">//界面基类
const {ccclass, property} = cc._decorator;

@ccclass
export default class ViewCtrl extends cc.Component {

    @property
    hasMask: boolean = true;

    @property
    touchOutClose: boolean = false;

    public onAddToStack(): void {
     }

     public onRemoveFromStack(): void {
     }

     public onPlayShowAni(): void {
     }

     public onPlayHideAni(): void {
     }
}</code></pre>
<p>接下来是<code>ViewGroup</code>这个类，它代表一个弹窗层，也继承自<code>cc.Component</code>，它的node可以添加到<code>PopupCtrl</code>的<code>node</code>上从而展示这个弹窗层。它应该有自己的<code>maskLayer</code>、<code>blockLayer</code>，用于显示灰色半透明遮罩，和屏蔽下层界面的触屏事件。当然，像<code>tips</code>层，我们不希望屏蔽下层界面的触屏事件，可以提供接口来控制这两个<code>layer</code>是否生效。</p>
<p><code>ViewGroup</code>最重要的作用是管理一层的弹窗。所以它应该有一个<code>Array&lt;ViewCtrl&gt;</code>类型的<code>viewArr</code>属性。基本的操作包括:</p>
<pre><code class="javascript">//界面组
export default class ViewGroup extends cc.Component {

     private maskLayer: cc.Node = null;
     private blockLayer: cc.Node = null;
     private viewArr: Array&lt;ViewCtrl&gt; = [];

     public pushView(ctrl: ViewCtrl, hideOld: boolean): void {
     }

     public popView(cleanup: boolean): void {
     }

     public insertView(ctrl: ViewCtrl): void {
     }

     public removeView(ctrl: ViewCtrl): void {
     }

     public pushViews(ctrls: Array&lt;ViewCtrl&gt;, hideOld: boolean): void {
     }

     public removeAllViews(cleanup: boolean): void {
     }

     public lastView(): ViewCtrl {
     }

     public getViewByName(name: string): ViewCtrl {
     }

     public getViewCount(): number {
     }

     public isEmpty(): boolean {
     }
}</code></pre>
<p>其中<code>pushView</code>、<code>insertView</code>、<code>pushViews</code>会将对应<code>ViewCtrl</code>放入<code>viewArr</code>，并触发<code>ViewCtrl.onAddToStack</code>。通过<code>ViewGroup.node.addChild</code>将<code>ViewCtrl.node</code>添加为子节点将对应界面显示出来。具体是否要添加到界面要看是否在<code>hideOld</code>的界面下面。<code>pushViews</code>主要是为自动弹窗设计的，例如登录后自动显示公告、签到等，关闭一个自动打开下一个。</p>
<p><code>popView</code>、<code>removeView</code>、<code>removeAllViews</code>通过<code>ViewCtrl.node.removeFromParent</code>将<code>ViewCtrl.node</code>移出界面，同时将ViewCtrl移出<code>viewArr</code>，并触发<code>ViewCtrl.onRemoveFromStack</code>。<code>pushView</code>、<code>popView</code>还会触发<code>onPlayShowAni</code>，<code>onPlayHideAni</code>这两个生命周期方法。</p>
<p>现在来说说<code>PopupCtrl</code>这个类，它也继承自<code>cc.Component</code>，可以直接挂载到<code>prefab</code>的节点上，在介绍游戏入口时我们给Canvas添加了<code>popupLayer</code>子节点，通过添加组件将<code>PopupCtr</code>l挂上去。<code>PopupCtrl</code>要实现分层，它有<code>Array&lt;ViewGroup&gt;</code>类型的<code>groupArr</code>属性。在<code>onLoaded</code>生命周期方法里按弹窗层顺序，通过<code>PopupCtrl.addChild</code>添加对应的弹窗层。<code>PopupCtrl</code>提供跟<code>ViewGroup</code>类似的接口，不同的是<code>PopupCtrl</code>的<code>pushView</code>、<code>insertView</code>、<code>pushViews</code>提供<code>layer</code>参数，用于指定弹窗添加的层。</p>
<pre><code class="javascript">enum PopupLayer {
    CONTENT = 0,
    TIPS,
    GUIDE,
    ALERT,
    LOADING
}</code></pre>                            </section>
                        </div>
                        <div class="search-results">
                            <div class="has-results">
                                <h1 class="search-results-title">
                                    关于"<span class='search-query'></span>"的搜索结果共<span class='search-results-count'></span>条
                                </h1>
                                <ul class="search-results-list"></ul>
                            </div>
                            <div class="no-results">
                                <h1 class="search-results-title">没有"<span class='search-query'></span>"相关内容</h1>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                <a href="https://naka1205.github.io/cocos/p/30A5A7449E53FF36.html" class="navigation navigation-prev " aria-label="资源管理">
            <i class="fa fa-angle-left"></i>
        </a>
                <a href="https://naka1205.github.io/cocos/p/BFFA75863D9BB58A.html" class="navigation navigation-next " aria-label="网络通信">
            <i class="fa fa-angle-right"></i>
        </a>
               
    </div>
<script>
var gitbook = gitbook || [];
gitbook.push(function() {
    gitbook.page.hasChanged({
        "page": {
            "title":  "弹窗管理",
            "next": {
                "title": "网络通信"
            },
            "previous": {
                "title": "资源管理"
            }
        },
        "config": {
            "gitbook": "*",
            "theme": "default",
            "variables": {},
            "plugins": ["-lunr", "-search", "-highlight","search-pro"],
            "pluginsConfig": {
                "search-pro": {},
                "highlight": {},
                "sharing": {},
                "fontsettings": {},
                "theme-default": {}
            },
            "structure": {},
            "pdf": {},
            "styles": {}
        },
        "file": {},
        "gitbook": {},
        "basePath": "https://naka1205.github.io/cocos",
        "book": {}
    });
});
</script>
</div>
<script src="https://naka1205.github.io/cocos/assets/js/gitbook.js"></script>
<script src="https://naka1205.github.io/cocos/assets/js/theme.js"></script>
<script src="https://naka1205.github.io/cocos/assets/js/jquery.mark.min.js"></script>
<script src="https://naka1205.github.io/cocos/assets/js/search.js"></script>
<script src="https://naka1205.github.io/cocos/assets/js/buttons.js"></script>
<script src="https://naka1205.github.io/cocos/assets/js/fontsettings.js"></script>
<script src="https://naka1205.github.io/cocos/assets/js/plugin.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/highlight.min.js"></script>
</body>
</html>