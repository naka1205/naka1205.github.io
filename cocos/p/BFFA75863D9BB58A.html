<!DOCTYPE HTML>
<html lang=""> 
<head>
    <meta charset="UTF-8">
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <title>网络通信 · PKBOOK</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="description" content="##网络通信前面已经介绍怎样加载资源、管理弹窗。开发一个网络游戏，难免要处理网络通信。有几点问题需要注意：1.服务端为了快速开发可能前期使用http通信，后面再改成websocket/socket。2...">
    <meta name="keywords" content="CocosCreator 教程">
    <meta name="generator" content="PKBook">
    <link rel="stylesheet" href="https://naka1205.github.io/cocos/assets/css/style.css">
    <link rel="stylesheet" href="https://naka1205.github.io/cocos/assets/css/search.css">
    <link rel="stylesheet" href="https://naka1205.github.io/cocos/assets/css/ebook.css">
    <link rel="stylesheet" href="https://naka1205.github.io/cocos/assets/css/website.css">
    <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/styles/github.min.css" rel="stylesheet">
    <meta name="HandheldFriendly" content="true" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://naka1205.github.io/cocos/assets/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="https://naka1205.github.io/cocos/assets/images/favicon.ico" type="image/x-icon">
</head>
<body>
<div class="book">
    <div class="book-summary">
        <div id="book-search-input" role="search">
            <input type="text" placeholder="输入关键词搜索" />
        </div>
        <nav role="navigation">
    <ul class="summary">
        <li><a href="https://naka1205.github.io/cocos/index.html" target="blank" class="header">序言</a></li>
        <li class="divider"></li>
                <li class="header">教程</li>
                        <li class="chapter " data-level="1.1" data-path="https://naka1205.github.io/cocos/p/60DA9CE88BF3343E.html"><a href="https://naka1205.github.io/cocos/p/60DA9CE88BF3343E.html">初识creator</a></li>
                        <li class="chapter " data-level="1.2" data-path="https://naka1205.github.io/cocos/p/30A5A7449E53FF36.html"><a href="https://naka1205.github.io/cocos/p/30A5A7449E53FF36.html">资源管理</a></li>
                        <li class="chapter " data-level="1.3" data-path="https://naka1205.github.io/cocos/p/11A6F2117472174E.html"><a href="https://naka1205.github.io/cocos/p/11A6F2117472174E.html">弹窗管理</a></li>
                        <li class="chapter  active " data-level="1.4" data-path="https://naka1205.github.io/cocos/p/BFFA75863D9BB58A.html"><a href="https://naka1205.github.io/cocos/p/BFFA75863D9BB58A.html">网络通信</a></li>
                        <li class="chapter " data-level="1.5" data-path="https://naka1205.github.io/cocos/p/37322E7BA0648835.html"><a href="https://naka1205.github.io/cocos/p/37322E7BA0648835.html">日志系统</a></li>
                        <li class="chapter " data-level="1.6" data-path="https://naka1205.github.io/cocos/p/748D14A6DC9142BB.html"><a href="https://naka1205.github.io/cocos/p/748D14A6DC9142BB.html">消息分发</a></li>
                        <li class="chapter " data-level="1.7" data-path="https://naka1205.github.io/cocos/p/DE657CA8EE77BE83.html"><a href="https://naka1205.github.io/cocos/p/DE657CA8EE77BE83.html">MVC架构</a></li>
                        <li class="chapter " data-level="1.8" data-path="https://naka1205.github.io/cocos/p/E593CAA756CFDE55.html"><a href="https://naka1205.github.io/cocos/p/E593CAA756CFDE55.html">代码结构</a></li>
                        <li class="chapter " data-level="1.9" data-path="https://naka1205.github.io/cocos/p/22AC2C263EC626A0.html"><a href="https://naka1205.github.io/cocos/p/22AC2C263EC626A0.html">瓦片地图</a></li>
                        <li class="chapter " data-level="1.10" data-path="https://naka1205.github.io/cocos/p/D44D258BFB70E858.html"><a href="https://naka1205.github.io/cocos/p/D44D258BFB70E858.html"> A*寻路</a></li>
                        <li class="chapter " data-level="1.11" data-path="https://naka1205.github.io/cocos/p/FB97038B212BD9C7.html"><a href="https://naka1205.github.io/cocos/p/FB97038B212BD9C7.html">有限状态机和行为树</a></li>
                    <li class="divider"></li>
                <li><a href="https://github.com/naka1205/pkbook" target="blank" class="gitbook-link">Published with PKBook</a></li>
    </ul>
</nav>
    </div>
    
    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
                <h1><i class="fa fa-circle-o-notch fa-spin"></i><a href="https://naka1205.github.io/cocos/p/BFFA75863D9BB58A.html">网络通信</a></h1>
            </div>
            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                    <div id="book-search-results">
                        <div class="search-noresults">
                            <section class="normal markdown-section">
                                <h2 id="%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1" name="%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1">网络通信</h2>
<p>前面已经介绍怎样加载资源、管理弹窗。开发一个网络游戏，难免要处理网络通信。有几点问题需要注意：</p>
<ol>
<li>服务端为了快速开发可能前期使用<code>http</code>通信，后面再改成<code>websocket/socket</code>。</li>
<li>同时存在<code>http</code>和<code>websocket/socket</code>通信</li>
<li>通信数据格式可能需要随时替换为<code>json</code>或<code>protocol buffer</code>，可能需要添加额外头部。</li>
<li>在新手引导里使用本地数据做模拟，请求不需要发送给后端。</li>
<li>重连后数据简单同步</li>
</ol>
<p>针对第一、二个问题，我在设计通信模块时会考虑将通信尽量抽象为统一的对外接口，在游戏启动时通过不同的驱动器创建实例（如果只使用一种通信方式，使用单一实例）。</p>
<pre><code class="javascript">public constructor(driver: ConnectDriver) {
    this._driver = driver;
}</code></pre>
<p>先定义通用的网络通信数据结构。其中请求分为数据和控制两种类型，用于区分心跳、登录、重连</p>
<pre><code class="javascript">//请求类型
export enum RequestType {
    DATA = 1,
    CTRL
}
//网络通信数据结构
export interface NetData {
    seq?: number; // 序列号
    mod: number; // 模块
    cmd: number; // 命令
    path?: string; // 路径
    data?: any; // 数据
    tmpData?: any; // 数据处理器临时数据
    status?: number; //状态码
    type?: RequestType;  //请求类型
}</code></pre>
<p>然后定义通用的对外接口</p>
<pre><code class="javascript">public open(url: string, port: number, isBinary: boolean, timeout: number, retryCount: number, params: any, cb: (succ: boolean) =&gt; void): void {}
public close(): number {}
public reopen(cb: (succ: boolean) =&gt; void): void {}
public sendData(data: NetData, params: HttpReq | any, succCb: (data: NetData) =&gt; void, failedCb: (code: number, reason: string) =&gt; void): void {}
public resendNotRecv(): void {}</code></pre>
<p>其中<code>resendNotRecv</code>用于重连后发送没有收到响应的包，后端根据序列号决定是否处理。
这里没有对推送的处理，实际上推送是接收到服务端数据后，调用广播给监听者。下面定义监听者</p>
<pre><code class="javascript">//网络连接事件监听接口
export interface ConnectEventListener {
    onOpen(driver: ConnectDriver);
    onClosed(driver: ConnectDriver);
    onError(driver: ConnectDriver, msg: string);
    onSendStart(driver: ConnectDriver);
    onRecvEnd(driver: ConnectDriver);
}
//网络事件监听接口
export interface NetEventListener extends ConnectEventListener {
    onPush(driver: ConnectDriver, data: NetData): void;
}</code></pre>
<p>对外提供注册和移除接口</p>
<pre><code class="javascript">public addEventListener(listener: NetEventListener): void {}
public removeEventListener(listener: NetEventListener): void {}</code></pre>
<p>针对第三个问题，需要定义一些预处理器，在发送数据前和接收到数据后，做拦截预处理。</p>
<pre><code class="javascript">//网络通信数据处理器接口
export interface NetDataProcessor {
    processReqData(data: any): any;
    processRespData(data: any): any;
}</code></pre>
<p>对外提供添加和移除接口，这样就可以灵活定义通信数据格式</p>
<pre><code class="javascript">public addDataProcessor(processor: NetDataProcessor): void {}
public removeDataProcessor(processor: NetDataProcessor): void {}</code></pre>
<p>针对第四个问题，同样是增加一个特殊的拦截器，在请求发送前对其处理，如果拦截器能处理，就不再发送给后端。</p>
<pre><code class="javascript">//模拟服务器接口
export interface SimServer {
    handleRequest(data: NetData): NetData;
}</code></pre>
<p>对外提供设置接口</p>
<pre><code class="javascript">public setSimServer(server: SimServer): void {}</code></pre>
<p>针对第五个问题，所有数据请求都有序列号，对请求进行记录，没有响应的请求包放到一个队列里，重连后重发这些包给后端处理。</p>
<pre><code class="javascript">public resendNotRecv(): void {}</code></pre>
<p>网络通信先说到这里，下一篇我们将介绍下怎样设计日志系统。</p>                            </section>
                        </div>
                        <div class="search-results">
                            <div class="has-results">
                                <h1 class="search-results-title">
                                    关于"<span class='search-query'></span>"的搜索结果共<span class='search-results-count'></span>条
                                </h1>
                                <ul class="search-results-list"></ul>
                            </div>
                            <div class="no-results">
                                <h1 class="search-results-title">没有"<span class='search-query'></span>"相关内容</h1>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                <a href="https://naka1205.github.io/cocos/p/11A6F2117472174E.html" class="navigation navigation-prev " aria-label="弹窗管理">
            <i class="fa fa-angle-left"></i>
        </a>
                <a href="https://naka1205.github.io/cocos/p/37322E7BA0648835.html" class="navigation navigation-next " aria-label="日志系统">
            <i class="fa fa-angle-right"></i>
        </a>
               
    </div>
<script>
var gitbook = gitbook || [];
gitbook.push(function() {
    gitbook.page.hasChanged({
        "page": {
            "title":  "网络通信",
            "next": {
                "title": "日志系统"
            },
            "previous": {
                "title": "弹窗管理"
            }
        },
        "config": {
            "gitbook": "*",
            "theme": "default",
            "variables": {},
            "plugins": ["-lunr", "-search", "-highlight","search-pro"],
            "pluginsConfig": {
                "search-pro": {},
                "highlight": {},
                "sharing": {},
                "fontsettings": {},
                "theme-default": {}
            },
            "structure": {},
            "pdf": {},
            "styles": {}
        },
        "file": {},
        "gitbook": {},
        "basePath": "https://naka1205.github.io/cocos",
        "book": {}
    });
});
</script>
</div>
<script src="https://naka1205.github.io/cocos/assets/js/gitbook.js"></script>
<script src="https://naka1205.github.io/cocos/assets/js/theme.js"></script>
<script src="https://naka1205.github.io/cocos/assets/js/jquery.mark.min.js"></script>
<script src="https://naka1205.github.io/cocos/assets/js/search.js"></script>
<script src="https://naka1205.github.io/cocos/assets/js/buttons.js"></script>
<script src="https://naka1205.github.io/cocos/assets/js/fontsettings.js"></script>
<script src="https://naka1205.github.io/cocos/assets/js/plugin.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/highlight.min.js"></script>
</body>
</html>