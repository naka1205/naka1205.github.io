<!DOCTYPE HTML>
<html lang=""> 
<head>
    <meta charset="UTF-8">
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <title>资源管理 · PKBOOK</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="description" content="在初识篇，我介绍过怎样加载prefab。cocos提供了一系列的加载接口">
    <meta name="keywords" content="CocosCreator 教程">
    <meta name="generator" content="PKBook">
    <link rel="stylesheet" href="https://naka1205.github.io/cocos/assets/css/style.css">
    <link rel="stylesheet" href="https://naka1205.github.io/cocos/assets/css/search.css">
    <link rel="stylesheet" href="https://naka1205.github.io/cocos/assets/css/ebook.css">
    <link rel="stylesheet" href="https://naka1205.github.io/cocos/assets/css/website.css">
    <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/styles/github.min.css" rel="stylesheet">
    <meta name="HandheldFriendly" content="true" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://naka1205.github.io/cocos/assets/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="https://naka1205.github.io/cocos/assets/images/favicon.ico" type="image/x-icon">
</head>
<body>
<div class="book">
    <div class="book-summary">
        <div id="book-search-input" role="search">
            <input type="text" placeholder="输入关键词搜索" />
        </div>
        <nav role="navigation">
    <ul class="summary">
        <li><a href="https://naka1205.github.io/cocos/index.html" target="blank" class="header">序言</a></li>
        <li class="divider"></li>
                <li class="header">教程</li>
                        <li class="chapter " data-level="1.1" data-path="https://naka1205.github.io/cocos/p/60DA9CE88BF3343E.html"><a href="https://naka1205.github.io/cocos/p/60DA9CE88BF3343E.html">初识creator</a></li>
                        <li class="chapter  active " data-level="1.2" data-path="https://naka1205.github.io/cocos/p/30A5A7449E53FF36.html"><a href="https://naka1205.github.io/cocos/p/30A5A7449E53FF36.html">资源管理</a></li>
                        <li class="chapter " data-level="1.3" data-path="https://naka1205.github.io/cocos/p/11A6F2117472174E.html"><a href="https://naka1205.github.io/cocos/p/11A6F2117472174E.html">弹窗管理</a></li>
                        <li class="chapter " data-level="1.4" data-path="https://naka1205.github.io/cocos/p/BFFA75863D9BB58A.html"><a href="https://naka1205.github.io/cocos/p/BFFA75863D9BB58A.html">网络通信</a></li>
                        <li class="chapter " data-level="1.5" data-path="https://naka1205.github.io/cocos/p/37322E7BA0648835.html"><a href="https://naka1205.github.io/cocos/p/37322E7BA0648835.html">日志系统</a></li>
                        <li class="chapter " data-level="1.6" data-path="https://naka1205.github.io/cocos/p/748D14A6DC9142BB.html"><a href="https://naka1205.github.io/cocos/p/748D14A6DC9142BB.html">消息分发</a></li>
                        <li class="chapter " data-level="1.7" data-path="https://naka1205.github.io/cocos/p/DE657CA8EE77BE83.html"><a href="https://naka1205.github.io/cocos/p/DE657CA8EE77BE83.html">MVC架构</a></li>
                        <li class="chapter " data-level="1.8" data-path="https://naka1205.github.io/cocos/p/E593CAA756CFDE55.html"><a href="https://naka1205.github.io/cocos/p/E593CAA756CFDE55.html">代码结构</a></li>
                        <li class="chapter " data-level="1.9" data-path="https://naka1205.github.io/cocos/p/22AC2C263EC626A0.html"><a href="https://naka1205.github.io/cocos/p/22AC2C263EC626A0.html">瓦片地图</a></li>
                        <li class="chapter " data-level="1.10" data-path="https://naka1205.github.io/cocos/p/D44D258BFB70E858.html"><a href="https://naka1205.github.io/cocos/p/D44D258BFB70E858.html"> A*寻路</a></li>
                        <li class="chapter " data-level="1.11" data-path="https://naka1205.github.io/cocos/p/FB97038B212BD9C7.html"><a href="https://naka1205.github.io/cocos/p/FB97038B212BD9C7.html">有限状态机和行为树</a></li>
                    <li class="divider"></li>
                <li><a href="https://github.com/naka1205/pkbook" target="blank" class="gitbook-link">Published with PKBook</a></li>
    </ul>
</nav>
    </div>
    
    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
                <h1><i class="fa fa-circle-o-notch fa-spin"></i><a href="https://naka1205.github.io/cocos/p/30A5A7449E53FF36.html">资源管理</a></h1>
            </div>
            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                    <div id="book-search-results">
                        <div class="search-noresults">
                            <section class="normal markdown-section">
                                <h2 id="%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86" name="%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86">资源管理</h2>
<p>在初识篇，我介绍过怎样加载<code>prefab</code>。<code>cocos</code>提供了一系列的加载接口，包括<code>cc.loader.load</code>，<code>cc.loader.loadRes</code>，<code>cc.loader.loadResArray</code>，<code>cc.loader.loadResDir</code>。</p>
<pre><code class="javascript">static load(resources: string|string[]|{uuid?: string, url?: string, type?: string}, completeCallback?: Function): void;

static loadRes(url: string, type: typeof cc.Asset, completeCallback: (error: Error, resource: any) =&gt; void): void;

static loadResArray(url: string[], type: typeof cc.Asset, progressCallback: (completedCount: number, totalCount: number, item: any) =&gt; void, completeCallback: ((error: Error, resource: any[]) =&gt; void)|null): void;

static loadResDir(url: string, type: typeof cc.Asset, progressCallback: (completedCount: number, totalCount: number, item: any) =&gt; void, completeCallback: ((error: Error, resource: any[], urls: string[]) =&gt; void)|null): void;
</code></pre>
<p>这些接口除了加载资源外，也负责资源管理。所以，在界面被销毁时，如果在<code>cc.loader</code>里还有该资源，资源是不会释放的。对于资源的管理，有两种方式，一种是资源加载后，<code>cc.loader</code>不管理资源，通过界面的引用来确定是否销毁资源。一种是<code>cc.loader</code>管理资源，界面使用资源，在模块退出时，通过<code>cc.loader</code>销毁资源。我偏向于第二种方式，这样避免依赖内存gc，资源可以得到即时释放。为了避免错误释放资源，在资源管理模块对加载的资源设置引用计数，引用计数为0时才实际销毁。</p>
<p>下面说说这几个接口的使用场景：</p>
<ol>
<li><code>cc.loader.load</code>用于加载第三方远程资源，在游戏中一般用于加载第三方平台的头像资源，如果该资源的链接没有文件后缀名，需要加参数{type:"png"}。</li>
<li><code>cc.loader.loadRes</code>用于加载<code>assets/resources</code>目录下单个资源</li>
<li><code>cc.loader.loadResArray</code>用于批量加载<code>assets/resources</code>目录下资源，比较适合于进度条加载界面，通过进度变化更新进度条。</li>
<li><code>cc.loader.loadResDir</code>用于加载<code>assets/resources</code>目录下单个目录的资源，一般我会把单个spine骨骼动画放在一个目录，把一个界面的资源放在一个目录。这样就可以通过这个接口加载单个spine动画或者一个界面的资源。</li>
</ol>
<p>在初识篇提到，我们建立<code>assets/resources</code>目录用于存放资源，目的是可以通过上述除了<code>cc.loader.load</code>外的接口加载资源，简化使用。</p>
<p><img src="http://files.kmei.org/1552015688352.jpg" alt="资源管理" title="资源管理" /></p>
<p>资源加载管理模块，可以划分为<code>ResLoader、ViewLoader</code>。其中ResLoader负责基础资源加载，另外提供超时、重试机制。<code>ViewLoader</code>负责对加载的<code>prefab</code>、重用界面的<code>node</code>进行缓存管理。这类工具性的类，我都习惯做成单例，一来游戏里只需要一个对象，另外单例有利于这些对象可以全局访问。</p>
<p><code>ResLoader</code>，封装<code>cc.loader</code>上述几个接口，以及对应的释放接口。</p>
<p>超时实现：设置回调控制变量，<code>settimeout</code>回调中设置变量，并调用超时回调，在成功失败处理中判断变量是否触发成功失败的回调。由于<code>cc.loader</code>本身有做资源管理，所以下次调用加载时如果已经通过<code>cc.loader</code>正在加载和成功加载的资源不会重复加载。</p>
<p>重试实现：通过变量记录加载次数，在失败和超时处理中判断是否达到重试次数，未达到则重新加载。</p>
<pre><code class="javascript">public static loadRes(url: string, type: typeof cc.Asset, completeCallback: (error: Error, resource: any) =&gt; void): void {
  let count = ResLoader.retryCount + 1;
  let hasCb = false;
  // timeout
  let timer = setTimeout(() =&gt; {
      hasCb = true;
      completeCallback &amp;&amp; completeCallback({
          name: "timeout",
          message: "timeout",
      }, null);
  }, ResLoader.timeout);
  // real load
  let realLoad = function() {
      count--;
      // load
      cc.loader.loadRes(url, type, (err, result) =&gt; {
          if (!err || count &lt;= 0) {
              clearTimeout(timer);
              !hasCb &amp;&amp; completeCallback &amp;&amp; completeCallback(err, result);
              return;
          }

          realLoad();
      });
  }; 
  realLoad();
}</code></pre>
<p><code>ViewLoader</code>，负责<code>prefab</code>和重用界面<code>node</code>的缓存，所以每个<code>prefab</code>都设置一个对应的<code>tag</code>，加载的prefab存放在Dictionary<code>&lt;number，cc.Prefab&gt;</code>类型的prefabDict属性中（<code>Dictionary</code>可以通过两个数组存放<code>key-value</code>封装出来），重用界面的<code>node</code>存放在<code>Dictionary</code> <code>&lt;number，cc.Node&gt;</code>类型的<code>nodeDict</code>属性中。</p>
<pre><code class="javascript">private static tag2prefabPathMap: Dictionary&lt;number, string&gt; = new Dictionary&lt;number, string&gt;();
private static tag2prefabMap: Dictionary&lt;number, cc.Prefab&gt; = new Dictionary&lt;number, cc.Prefab&gt;();
private static tag2nodeMap: Dictionary&lt;number, cc.Node&gt; = new Dictionary&lt;number, cc.Node&gt;();</code></pre>
<p>通过<code>ResLoader</code>加载<code>cc.Prefab</code>。<code>cc.instantiate</code>实例出<code>node</code>节点</p>
<pre><code class="javascript">let instantiatePrefab = function(prefab: cc.Prefab) {
  let node = cc.instantiate(prefab);
  if (reuse &amp;&amp; !ViewLoader.tag2nodeMap.hasKey(tag)) {
      ViewLoader.tag2nodeMap.set(tag, node);
  }
  cb &amp;&amp; cb(node);
}</code></pre>                            </section>
                        </div>
                        <div class="search-results">
                            <div class="has-results">
                                <h1 class="search-results-title">
                                    关于"<span class='search-query'></span>"的搜索结果共<span class='search-results-count'></span>条
                                </h1>
                                <ul class="search-results-list"></ul>
                            </div>
                            <div class="no-results">
                                <h1 class="search-results-title">没有"<span class='search-query'></span>"相关内容</h1>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                <a href="https://naka1205.github.io/cocos/p/60DA9CE88BF3343E.html" class="navigation navigation-prev " aria-label="初识creator">
            <i class="fa fa-angle-left"></i>
        </a>
                <a href="https://naka1205.github.io/cocos/p/11A6F2117472174E.html" class="navigation navigation-next " aria-label="弹窗管理">
            <i class="fa fa-angle-right"></i>
        </a>
               
    </div>
<script>
var gitbook = gitbook || [];
gitbook.push(function() {
    gitbook.page.hasChanged({
        "page": {
            "title":  "资源管理",
            "next": {
                "title": "弹窗管理"
            },
            "previous": {
                "title": "初识creator"
            }
        },
        "config": {
            "gitbook": "*",
            "theme": "default",
            "variables": {},
            "plugins": ["-lunr", "-search", "-highlight","search-pro"],
            "pluginsConfig": {
                "search-pro": {},
                "highlight": {},
                "sharing": {},
                "fontsettings": {},
                "theme-default": {}
            },
            "structure": {},
            "pdf": {},
            "styles": {}
        },
        "file": {},
        "gitbook": {},
        "basePath": "https://naka1205.github.io/cocos",
        "book": {}
    });
});
</script>
</div>
<script src="https://naka1205.github.io/cocos/assets/js/gitbook.js"></script>
<script src="https://naka1205.github.io/cocos/assets/js/theme.js"></script>
<script src="https://naka1205.github.io/cocos/assets/js/jquery.mark.min.js"></script>
<script src="https://naka1205.github.io/cocos/assets/js/search.js"></script>
<script src="https://naka1205.github.io/cocos/assets/js/buttons.js"></script>
<script src="https://naka1205.github.io/cocos/assets/js/fontsettings.js"></script>
<script src="https://naka1205.github.io/cocos/assets/js/plugin.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/highlight.min.js"></script>
</body>
</html>