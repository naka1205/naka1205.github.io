<!DOCTYPE HTML>
<html lang=""> 
<head>
    <meta charset="UTF-8">
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <title>执行程序实例 · C++实例教程</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="description" content="整理到这里,其实已经可以开始运行看看,不过我们还是先把光盘里的程序实例稍微再加工一下。关于追加部分的处理,先执行程序实例会比较容易懂吧!请实际运行一下程序实例,程序实例就在随书附赠光盘的“chapter6”文件夹下。">
    <meta name="keywords" content="角色扮演 教程">
    <meta name="generator" content="PKBook">
    <link rel="stylesheet" href="https://naka1205.github.io/rpgsample/assets/css/style.css">
    <link rel="stylesheet" href="https://naka1205.github.io/rpgsample/assets/css/search.css">
    <link rel="stylesheet" href="https://naka1205.github.io/rpgsample/assets/css/ebook.css">
    <link rel="stylesheet" href="https://naka1205.github.io/rpgsample/assets/css/website.css">
    <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/styles/github.min.css" rel="stylesheet">
    <meta name="HandheldFriendly" content="true" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://naka1205.github.io/rpgsample/assets/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="https://naka1205.github.io/rpgsample/assets/images/favicon.ico" type="image/x-icon">
</head>
<body>
<div class="book">
    <div class="book-summary">
        <div id="book-search-input" role="search">
            <input type="text" placeholder="输入关键词搜索" />
        </div>
        <nav role="navigation">
    <ul class="summary">
        <li><a href="https://naka1205.github.io/rpgsample/index.html" target="blank" class="header">说明</a></li>
        <li class="divider"></li>
                <li class="header">写一个角色扮演游戏</li>
                        <li class="chapter " data-level="1.1" data-path="https://naka1205.github.io/rpgsample/p/FEEC8D8FB78C0C58.html"><a href="https://naka1205.github.io/rpgsample/p/FEEC8D8FB78C0C58.html">何谓角色扮演游戏（RPG）</a></li>
                        <li class="chapter " data-level="1.2" data-path="https://naka1205.github.io/rpgsample/p/BC79B4D3134C347C.html"><a href="https://naka1205.github.io/rpgsample/p/BC79B4D3134C347C.html">RPG分类</a></li>
                        <li class="chapter " data-level="1.3" data-path="https://naka1205.github.io/rpgsample/p/F20DC96FA50A49C7.html"><a href="https://naka1205.github.io/rpgsample/p/F20DC96FA50A49C7.html">写RPG时的软硬件需求</a></li>
                    <li class="divider"></li>
                <li class="header">游戏系统的设计</li>
                        <li class="chapter " data-level="2.1" data-path="https://naka1205.github.io/rpgsample/p/057DE479BA15F0C2.html"><a href="https://naka1205.github.io/rpgsample/p/057DE479BA15F0C2.html">RPG系统</a></li>
                        <li class="chapter " data-level="2.2" data-path="https://naka1205.github.io/rpgsample/p/98A9BEB4C06AB6F5.html"><a href="https://naka1205.github.io/rpgsample/p/98A9BEB4C06AB6F5.html">RPG的必备功能和设计</a></li>
                    <li class="divider"></li>
                <li class="header">Windows程序设计</li>
                        <li class="chapter " data-level="3.1" data-path="https://naka1205.github.io/rpgsample/p/29DEF3B121E67E34.html"><a href="https://naka1205.github.io/rpgsample/p/29DEF3B121E67E34.html">游戏的必备功能</a></li>
                        <li class="chapter " data-level="3.2" data-path="https://naka1205.github.io/rpgsample/p/E250E5C20EC8FDF3.html"><a href="https://naka1205.github.io/rpgsample/p/E250E5C20EC8FDF3.html">开启窗口</a></li>
                        <li class="chapter " data-level="3.3" data-path="https://naka1205.github.io/rpgsample/p/7FA5E0693CC56877.html"><a href="https://naka1205.github.io/rpgsample/p/7FA5E0693CC56877.html">显示CG</a></li>
                        <li class="chapter " data-level="3.4" data-path="https://naka1205.github.io/rpgsample/p/FF11E655570F0335.html"><a href="https://naka1205.github.io/rpgsample/p/FF11E655570F0335.html">显示CG的应用软件</a></li>
                        <li class="chapter " data-level="3.5" data-path="https://naka1205.github.io/rpgsample/p/FD772D011D420B30.html"><a href="https://naka1205.github.io/rpgsample/p/FD772D011D420B30.html">CG/Sprite的重叠显示</a></li>
                        <li class="chapter " data-level="3.6" data-path="https://naka1205.github.io/rpgsample/p/9505172717587147.html"><a href="https://naka1205.github.io/rpgsample/p/9505172717587147.html">贴图零件(sprite)显示</a></li>
                    <li class="divider"></li>
                <li class="header">显示地图和人物</li>
                        <li class="chapter " data-level="4.1" data-path="https://naka1205.github.io/rpgsample/p/D669497E6697FA89.html"><a href="https://naka1205.github.io/rpgsample/p/D669497E6697FA89.html">地图坐标系</a></li>
                        <li class="chapter " data-level="4.2" data-path="https://naka1205.github.io/rpgsample/p/CB9C77BD644B1669.html"><a href="https://naka1205.github.io/rpgsample/p/CB9C77BD644B1669.html">Sprite的显示</a></li>
                        <li class="chapter " data-level="4.3" data-path="https://naka1205.github.io/rpgsample/p/D4F60F30B7F0944A.html"><a href="https://naka1205.github.io/rpgsample/p/D4F60F30B7F0944A.html">显示的程序实例</a></li>
                    <li class="divider"></li>
                <li class="header">人物移动</li>
                        <li class="chapter " data-level="5.1" data-path="https://naka1205.github.io/rpgsample/p/9BDC29F23C108FCD.html"><a href="https://naka1205.github.io/rpgsample/p/9BDC29F23C108FCD.html">移动的思维方式</a></li>
                        <li class="chapter " data-level="5.2" data-path="https://naka1205.github.io/rpgsample/p/294F9E27361163C8.html"><a href="https://naka1205.github.io/rpgsample/p/294F9E27361163C8.html">移动的动画</a></li>
                        <li class="chapter " data-level="5.3" data-path="https://naka1205.github.io/rpgsample/p/850A8F5D7D49913A.html"><a href="https://naka1205.github.io/rpgsample/p/850A8F5D7D49913A.html">移动的程序实例</a></li>
                    <li class="divider"></li>
                <li class="header">战斗</li>
                        <li class="chapter " data-level="6.1" data-path="https://naka1205.github.io/rpgsample/p/714FCCE62BEAE7EF.html"><a href="https://naka1205.github.io/rpgsample/p/714FCCE62BEAE7EF.html">读入地图数据</a></li>
                        <li class="chapter " data-level="6.2" data-path="https://naka1205.github.io/rpgsample/p/DE18A13DD466BCF5.html"><a href="https://naka1205.github.io/rpgsample/p/DE18A13DD466BCF5.html">战斗规则</a></li>
                        <li class="chapter " data-level="6.3" data-path="https://naka1205.github.io/rpgsample/p/372F73F2A1CBD002.html"><a href="https://naka1205.github.io/rpgsample/p/372F73F2A1CBD002.html">攻击时的动画</a></li>
                        <li class="chapter " data-level="6.4" data-path="https://naka1205.github.io/rpgsample/p/D6377D95C3DAE065.html"><a href="https://naka1205.github.io/rpgsample/p/D6377D95C3DAE065.html">魔法攻击的处理</a></li>
                        <li class="chapter " data-level="6.5" data-path="https://naka1205.github.io/rpgsample/p/84AF096B75C4D0F4.html"><a href="https://naka1205.github.io/rpgsample/p/84AF096B75C4D0F4.html">CPU端的思维模式</a></li>
                        <li class="chapter " data-level="6.6" data-path="https://naka1205.github.io/rpgsample/p/ECD1A205E33A1347.html"><a href="https://naka1205.github.io/rpgsample/p/ECD1A205E33A1347.html">CPU端人物的攻击</a></li>
                        <li class="chapter  active " data-level="6.7" data-path="https://naka1205.github.io/rpgsample/p/FAC327CB74DDD86D.html"><a href="https://naka1205.github.io/rpgsample/p/FAC327CB74DDD86D.html">执行程序实例</a></li>
                    <li class="divider"></li>
                <li class="header">事件</li>
                        <li class="chapter " data-level="7.1" data-path="https://naka1205.github.io/rpgsample/p/9308712D0BA44B6C.html"><a href="https://naka1205.github.io/rpgsample/p/9308712D0BA44B6C.html">事件的执行方法</a></li>
                        <li class="chapter " data-level="7.2" data-path="https://naka1205.github.io/rpgsample/p/EA6BA727743E6636.html"><a href="https://naka1205.github.io/rpgsample/p/EA6BA727743E6636.html">命令的执行处理</a></li>
                        <li class="chapter " data-level="7.3" data-path="https://naka1205.github.io/rpgsample/p/1FD117B39A12879F.html"><a href="https://naka1205.github.io/rpgsample/p/1FD117B39A12879F.html">效果</a></li>
                    <li class="divider"></li>
                <li class="header">编辑参数</li>
                        <li class="chapter " data-level="8.1" data-path="https://naka1205.github.io/rpgsample/p/BE63E223F2902F52.html"><a href="https://naka1205.github.io/rpgsample/p/BE63E223F2902F52.html">参数</a></li>
                        <li class="chapter " data-level="8.2" data-path="https://naka1205.github.io/rpgsample/p/FCD874DB5CE467EB.html"><a href="https://naka1205.github.io/rpgsample/p/FCD874DB5CE467EB.html">参数编辑器</a></li>
                    <li class="divider"></li>
                <li class="header">大功告成</li>
                        <li class="chapter " data-level="9.1" data-path="https://naka1205.github.io/rpgsample/p/1107A00384B06596.html"><a href="https://naka1205.github.io/rpgsample/p/1107A00384B06596.html">增补其他功能</a></li>
                        <li class="chapter " data-level="9.2" data-path="https://naka1205.github.io/rpgsample/p/4E29E074EC583114.html"><a href="https://naka1205.github.io/rpgsample/p/4E29E074EC583114.html">从外部文件读入参数</a></li>
                        <li class="chapter " data-level="9.3" data-path="https://naka1205.github.io/rpgsample/p/466677A509CFE1D8.html"><a href="https://naka1205.github.io/rpgsample/p/466677A509CFE1D8.html">结合战斗部分和故事大纳</a></li>
                        <li class="chapter " data-level="9.4" data-path="https://naka1205.github.io/rpgsample/p/A7636FB800B97FD5.html"><a href="https://naka1205.github.io/rpgsample/p/A7636FB800B97FD5.html">播放音乐</a></li>
                        <li class="chapter " data-level="9.5" data-path="https://naka1205.github.io/rpgsample/p/6CB6CA31DF912DC1.html"><a href="https://naka1205.github.io/rpgsample/p/6CB6CA31DF912DC1.html">存储/装入</a></li>
                        <li class="chapter " data-level="9.6" data-path="https://naka1205.github.io/rpgsample/p/DFAF0C32BFFE733B.html"><a href="https://naka1205.github.io/rpgsample/p/DFAF0C32BFFE733B.html">播放音效</a></li>
                        <li class="chapter " data-level="9.7" data-path="https://naka1205.github.io/rpgsample/p/26C22A438848C588.html"><a href="https://naka1205.github.io/rpgsample/p/26C22A438848C588.html">提升等级</a></li>
                        <li class="chapter " data-level="9.8" data-path="https://naka1205.github.io/rpgsample/p/B5D1DD2411A4AD87.html"><a href="https://naka1205.github.io/rpgsample/p/B5D1DD2411A4AD87.html">直接跳跃</a></li>
                        <li class="chapter " data-level="9.9" data-path="https://naka1205.github.io/rpgsample/p/3F050F1718FBC3D8.html"><a href="https://naka1205.github.io/rpgsample/p/3F050F1718FBC3D8.html">故事大纲实例</a></li>
                    <li class="divider"></li>
                <li class="header">浅谈即时系统</li>
                        <li class="chapter " data-level="10.1" data-path="https://naka1205.github.io/rpgsample/p/3A99ECF04F2323C2.html"><a href="https://naka1205.github.io/rpgsample/p/3A99ECF04F2323C2.html">战略型即时系统的基本概念</a></li>
                    <li class="divider"></li>
                <li><a href="https://github.com/naka1205/pkbook" target="blank" class="gitbook-link">Published with PKBook</a></li>
    </ul>
</nav>
    </div>
    
    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
                <h1><i class="fa fa-circle-o-notch fa-spin"></i><a href="https://naka1205.github.io/rpgsample/p/FAC327CB74DDD86D.html">执行程序实例</a></h1>
            </div>
            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                    <div id="book-search-results">
                        <div class="search-noresults">
                            <section class="normal markdown-section">
                                <h3 id="%E6%89%A7%E8%A1%8C%E7%A8%8B%E5%BA%8F%E5%AE%9E%E4%BE%8B" name="%E6%89%A7%E8%A1%8C%E7%A8%8B%E5%BA%8F%E5%AE%9E%E4%BE%8B">执行程序实例</h3>
<p>整理到这里,其实已经可以开始运行看看,不过我们还是先把光盘里的程序实例稍微再加工一下。</p>
<p>关于追加部分的处理,先执行程序实例会比较容易懂吧!请实际运行一下程序实例,程序实例就在随书附赠光盘的“chapter6”文件夹下。</p>
<h4 id="%E6%98%BE%E7%A4%BA%E7%8A%B6%E6%80%81" name="%E6%98%BE%E7%A4%BA%E7%8A%B6%E6%80%81">显示状态</h4>
<p>首先,把眼标光标对到人物所在的方格上,就会跳出弹出式状态说明。如果不想办法显示出状态的话,游戏玩家不会知道还剩下多少HP值,所以这个功能不能少。这里的程序实例是当光标移动到方格上时即跳出相关说明的方式。</p>
<p>程序实例还有另一个状态说明,只是用来给游戏玩家看,显示经验值不,如图6-9所示。</p>
<p>对程序设计师而言,在固定位置显示状态会比较好写,可是这样会连可显示数量也都固定不能改变。话虽如此,如果只考虑到游戏玩家这边的状态显示,其实数量固定也没什么问题才对。</p>
<p>状态显示是先在内存上产生图像,然后在画面上合成出最后我们所看到的样子。</p>
<p>产生状态图像(Battle.cpp)</p>
<pre><code class="C++">//
// 建立人物状态的图像
//
void CBattleAction::SetPlayerStatus(int player)
{
    Status[player].Copy(&amp;StatusBase);
    if (StatusCharacter[player] != 0) {
        CStatus &amp;status = StatusCharacter[player]-&gt;status;
        CImageDC dc(Status + player);
        HFONT   oldFont = dc.SelectObject(hFont);
        dc.SetTextColor(WhitePixel);
        dc.SetBkMode(TRANSPARENT);

        char str[256];
        dc.ExtTextOut(10, 4, 0, 0, status.name, strlen(status.name), NULL);
        dc.ExtTextOut(10, 22, 0, 0, str,
                    sprintf(str, "等级　　　%7d", status.level), NULL);
        dc.ExtTextOut(10, 40, 0, 0, str,
                    sprintf(str, "经验值　　%7d", status.experience), NULL);
        dc.ExtTextOut(10, 58, 0, 0, str,
                    sprintf(str, "HP值　　%3d/%3d",
                        status.hit_point, status.max_hit_point), NULL);
        dc.ExtTextOut(10, 76, 0, 0, str,
                    sprintf(str, "MP值　　%3d/%3d",
                        status.magic_point, status.max_magic_point), NULL);

        dc.SelectObject(oldFont);
    }
}</code></pre>
<p>画面下方给游戏玩家看的状态显示都是“文字”显示。因为用DIBSection所产生的图像可以取得DC,故可利用ExtTextOut绘制出文字内容。</p>
<h5 id="%E8%AE%BE%E8%AE%A1%E5%BC%B9%E5%87%BA%E5%BC%8F%E7%8A%B6%E6%80%81%E8%AF%B4%E6%98%8E" name="%E8%AE%BE%E8%AE%A1%E5%BC%B9%E5%87%BA%E5%BC%8F%E7%8A%B6%E6%80%81%E8%AF%B4%E6%98%8E">设计弹出式状态说明</h5>
<p>弹出式状态说明(pop-upstatus)其实就是CG的组合而已。虽然做起来颇费工夫,但会比较好应用。</p>
<p>即使设计成等到最后再转成CG、显示到画面上,但是中间只要稍有变动,CG和程序代码两边都得修改,实在很麻烦。因此一开始先“暂时”不要用CG,只用程序去绘制,等到显示内容确定之后再改成CG显示也是一个聪明的做法。</p>
<p>先如图6-10制作出显示用的“背景”CG和“零件”CG,再利用程序组合起来使用。</p>
<p>弹出式状态说明(Battle.cpp)</p>
<pre><code class="C++">//
// 显示突现式状态说明
//
void CBattleAction::ChangeStatus(CPoint point)
{
    if (MapRect.PtInRect(point) &amp;&amp; map_data[point.y][point.x].type &amp; (PLAYER | ENEMY)) {
        if (StatusChar != (CCharacter *)map_data[point.y][point.x].sprite) {
            StatusChar = 0;

            RedrawSprite(&amp;PopupSprite);     // 删除之前的显示
            StatusChar = (CCharacter *)map_data[point.y][point.x].sprite;
            CStatus &amp;status = StatusChar-&gt;status;

            // 组合状态显示的零件
            PopupImage.Copy(&amp;PopupImageBase);   // 复制原始图像
            PopupImage.DrawText(hFont, 1, 1, status.name, RGB(0, 0, 0));
            PopupImage.DrawText(hFont, 0, 0, status.name);

            int hp_len = status.hit_point * 76 / status.max_hit_point;
            int mp_len = status.magic_point * 76 / status.max_magic_point;
            PopupImage.Copy(&amp;PopupParts, CRect(21, 17, 21 + hp_len, 20), CPoint(0, 20));
            PopupImage.Copy(&amp;PopupParts, CRect(21, 32, 21 + mp_len, 35), CPoint(0, 23));

            char hp_str[4], mp_str[4], mhp_str[4], mmp_str[4];
            sprintf(hp_str, "%03d", status.hit_point);
            sprintf(mp_str, "%03d", status.magic_point);
            sprintf(mhp_str, "%03d", status.max_hit_point);
            sprintf(mmp_str, "%03d", status.max_magic_point);

            for (int i=0; i&lt;3; i++) {
                PopupImage.Copy(&amp;PopupParts,
                                    CRect(42 + i * 8, 21, 50 + i * 8, 31),
                                    CPoint((hp_str[i] - '0') * 8, 0));
                PopupImage.Copy(&amp;PopupParts,
                                    CRect(74 + i * 8, 21, 82 + i * 8, 31),
                                    CPoint((mhp_str[i] - '0') * 8, 0));
                PopupImage.Copy(&amp;PopupParts, 
                                    CRect(42 + i * 8, 36, 50 + i * 8, 46),
                                    CPoint((mp_str[i] - '0') * 8, 10));
                PopupImage.Copy(&amp;PopupParts,
                                    CRect(74 + i * 8, 36, 82 + i * 8, 46),
                                    CPoint((mmp_str[i] - '0') * 8, 10));
            }
            point = IndexToPoint(point);
            point.x += (MAPGRID_WIDTH - PopupImage.Width()) / 2;
            point.y -= 64;

            // 若不在范围内，则放在窗口内
            if (point.x &lt; 0) {
                point.x = 0;
            }
            else if (point.x &gt;= WindowWidth - PopupImage.Width()) {
                point.x = WindowWidth - PopupImage.Width();
            }
            if (point.y &lt; 0) {
                point.y = 0;
            }

            PopupSprite.SetDrawPos(point);
            RedrawSprite(&amp;PopupSprite);     // 显示
        }
    }
    else if (StatusChar != 0) {     // 有显示状态，但不在人物上
        StatusChar = 0;
        RedrawSprite(&amp;PopupSprite);     // 删除之前的显示
    }
}</code></pre>
<p>HP、MP要先计算显示长度,再从零件去复制需要的长度。</p>
<pre><code class="C++">int hp_len = status.hit_point * 76 / status.max_hit_point;
PopupImage.Copy(&amp;PopupParts, 
                CRect(21, 17, 21 + hp_len, 20), //复制~到
                CPoint(0, 20));                 //从~复制</code></pre>
<p>数字转换成字符串后,再逐一复制字符。</p>
<pre><code class="C++">sprintf(hp_str, "%03d", status.hit_point);
for (int i=0; i&lt;3; i++) {
    PopupImage.Copy(&amp;PopupParts,
                    CRect(42 + i * 8, 21, 50 + i * 8, 31),
                    CPoint((hp_str[i] - '0') * 8, 0));
｝</code></pre>
<p>利用这种方法组合显示图像后,让它能配合光标位置显示在画面上。</p>
<p>执行程序,把鼠标光标移动到人物上方,就可以看到光标所指人物的状态说明了。</p>
<h4 id="%E8%BE%93%E5%85%A5%E5%91%BD%E4%BB%A4" name="%E8%BE%93%E5%85%A5%E5%91%BD%E4%BB%A4">输入命令</h4>
<p>当鼠标光标移动到人物上并按下鼠标左键时,就会显示菜单。</p>
<p>这个菜单是利用sprite所绘制而成。sprite是从图6-11的菜单用CG而来,由左而右的状态分别是“一般”、“已选用过”和“无法选取”。</p>
<p>只要利用此CG上当时可用命令的部分,即可产生并显示sprite。</p>
<p>显示命令菜单(Battle.cpp)</p>
<pre><code class="C++">// 显示命令菜单
CPoint CBattleAction::CommandIndex(int idx)
{
    // 移动
    switch (idx) {
      case COMMAND_MOVE:        // 移动
        return CPoint(SelChar-&gt;move_done? 140: 0, 0);

      case COMMAND_ATTACK:      // 直接攻击
        return CPoint(SelChar-&gt;attack_done? 140: 0, 22);

      default:                  // 魔法
        idx -= COMMAND_MAGIC_FIRST;
        if (SelChar-&gt;IsMagicOk(idx)) {
            return CPoint(SelChar-&gt;attack_done? 140: 0,
                SelChar-&gt;GetMagicParam(idx).id * 22 + 44);
        }
        return CPoint(-1, -1);
    }
}

void CBattleAction::ShowCommand(CPoint point)
{
    if (point.x &gt; 320)
        point.x -= 70 + 24;
    else
        point.x += 24;

    status = STATUS_COMMAND;
    select = COMMAND_NO_SELECT;

    for (int i=0; i&lt;MAX_COMMAND; i++) {
        CPoint src = CommandIndex(i);
        if (src.x &gt;= 0) {
            CommandSprite[i].SetDrawPos(point.x, point.y);
            CommandSprite[i].SetSrcPos(src.x, src.y);
            CommandSprite[i].Show();
            RedrawSprite(CommandSprite + i);
            point.y += 23;
        }
    }
}</code></pre>
<p>因为菜单是配合鼠标光标位置而显示,所以当光标在画面右边时,菜单应显示在左方,当光标在画面左边时,则菜单应显示在右方,这样菜单才不会跑到画面之外。</p>
<p>选择命令菜单(Battle.cpp)</p>
<pre><code class="C++">// 选择命令菜单--让它反白
void CBattleAction::HighlightCommand(int newsel, bool selection)
{
    if (newsel != COMMAND_NO_SELECT) {
        CSprite *sp = CommandSprite + newsel;
        sp-&gt;SetSrcPos(selection? 70: 0, sp-&gt;GetSrcPos().y);
        RedrawSprite(sp);
    }
}

void CBattleAction::HighlightCommand(CPoint point)
{
    int newsel = FindCommand(point);
    if (select != newsel) {
        HighlightCommand(select, false);
        select = newsel;
        HighlightCommand(select, true);
    }
}</code></pre>
<p>当鼠标光标放在菜单上时,则应做“反白显示”。反白就是CG的第2个(已选择),因此错开sprite的显示CG就可以切换已选择/解除选择。</p>
<p>删除命令菜单(Battle.cpp)</p>
<pre><code class="C++">// 删除命令菜单
void CBattleAction::HideCommand()
{
    for (int i=0; i&lt;MAX_COMMAND; i++) {
        if (CommandSprite[i].IsShow()) {
            CommandSprite[i].Show(false);
            RedrawSprite(CommandSprite + i);
        }
    }
}</code></pre>
<p>因为菜单是sprite显示,故将sprite设为“不显示”即可删除菜单。</p>
<p>执行命令(Battle.cpp)</p>
<pre><code class="C++">// 选择命令菜单
void CBattleAction::SelectCommand(CPoint point)
{
    int sel = FindCommand(point);
    switch (sel) {
      case COMMAND_NO_SELECT:
        break;

      case COMMAND_MOVE:
        HideCommand();
        status = STATUS_MOVE;
        FindDist(SelPos.x, SelPos.y, SelChar-&gt;status.move_dist);
        break;

      case COMMAND_ATTACK:
        HideCommand();
        status = STATUS_ATTACK;
        FindAttack(SelPos.x, SelPos.y, SelChar-&gt;status.attack_dist);
        break;

      default:
        HideCommand();
        magic_param = SelChar-&gt;GetMagicParam(sel - COMMAND_MAGIC_FIRST);
        if (magic_param.type == MAGIC_TYPE_SELF) {
            status = STATUS_MAGIC_PLAYER;
            FindAttack(SelPos.x, SelPos.y, magic_param.dist, false);
        }
        else {
            status = STATUS_MAGIC_ENEMY;
            FindAttack(SelPos.x, SelPos.y, magic_param.dist);
        }
        break;
    }
}

// 从命令菜单的位置开始搜寻
int CBattleAction::FindCommand(CPoint point)
{
    if (!SelChar-&gt;move_done &amp;&amp; CommandSprite[COMMAND_MOVE].PtIn(point))
        return COMMAND_MOVE;

    if (!SelChar-&gt;attack_done) {
        for (int i=COMMAND_ATTACK; i&lt;MAX_COMMAND; i++) {
            if (CommandSprite[i].PtIn(point))
                return i;
        }
    }
    return COMMAND_NO_SELECT;
}</code></pre>
<p>若已选择命令时,则移往“下一个步骤”。下一个步骤是指,如为移动则显示移动范围(如为攻击则显示攻击范围),然后等待游戏玩家点选。</p>
<p>等到游戏玩家所选人物的行动均已设定之后,再按鼠标右键选择“Turnend”(本轮结束),就换成轮到敌方动作。“Turnend”菜单也是以script显示。敌方的动作会根据前面所说明的计算方式进行。</p>
<p>如此重复下去就是一场战斗了。</p>
<p>因为游戏结束的故事大纲还没写,所以指在VisualC++的调试窗口显示“打赢”或“战败”来表示游戏结束,不过输赢只在是否全军覆没,相信各位不需要去看VisualC++的调试窗口就知输赢如何了。</p>
<p>还有,这里并没有用到随机数,因此是游戏玩家胜出的参数。如果怎么打都打不赢,稍微提高游戏玩家这边的HP就能让敌方兵败如山倒。嗯,各位也可以考虑在调试用的部分放一个不为人知的“必胜方程序”的命令(别搞错,这只是调试用而已)。</p>                            </section>
                        </div>
                        <div class="search-results">
                            <div class="has-results">
                                <h1 class="search-results-title">
                                    关于"<span class='search-query'></span>"的搜索结果共<span class='search-results-count'></span>条
                                </h1>
                                <ul class="search-results-list"></ul>
                            </div>
                            <div class="no-results">
                                <h1 class="search-results-title">没有"<span class='search-query'></span>"相关内容</h1>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                <a href="https://naka1205.github.io/rpgsample/p/ECD1A205E33A1347.html" class="navigation navigation-prev " aria-label="CPU端人物的攻击">
            <i class="fa fa-angle-left"></i>
        </a>
                <a href="https://naka1205.github.io/rpgsample/p/9308712D0BA44B6C.html" class="navigation navigation-next " aria-label="事件的执行方法">
            <i class="fa fa-angle-right"></i>
        </a>
               
    </div>
<script>
var gitbook = gitbook || [];
gitbook.push(function() {
    gitbook.page.hasChanged({
        "page": {
            "title":  "执行程序实例",
            "next": {
                "title": "事件的执行方法"
            },
            "previous": {
                "title": "CPU端人物的攻击"
            }
        },
        "config": {
            "gitbook": "*",
            "theme": "default",
            "variables": {},
            "plugins": ["-lunr", "-search", "-highlight","search-pro"],
            "pluginsConfig": {
                "search-pro": {},
                "highlight": {},
                "sharing": {},
                "fontsettings": {},
                "theme-default": {}
            },
            "structure": {},
            "pdf": {},
            "styles": {}
        },
        "file": {},
        "gitbook": {},
        "basePath": "https://naka1205.github.io/rpgsample",
        "book": {}
    });
});
</script>
</div>
<script src="https://naka1205.github.io/rpgsample/assets/js/gitbook.js"></script>
<script src="https://naka1205.github.io/rpgsample/assets/js/theme.js"></script>
<script src="https://naka1205.github.io/rpgsample/assets/js/jquery.mark.min.js"></script>
<script src="https://naka1205.github.io/rpgsample/assets/js/search.js"></script>
<script src="https://naka1205.github.io/rpgsample/assets/js/buttons.js"></script>
<script src="https://naka1205.github.io/rpgsample/assets/js/fontsettings.js"></script>
<script src="https://naka1205.github.io/rpgsample/assets/js/plugin.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/highlight.min.js"></script>
</body>
</html>