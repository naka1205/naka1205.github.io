<!DOCTYPE HTML>
<html lang=""> 
<head>
    <meta charset="UTF-8">
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <title>地图坐标系 · C++实例教程</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="description" content="必须先有一个坐标系,才能显示地图或人物。如果使用的地图是垂直向下看的方格地图,画面显示的坐标系即同地图的坐标系(只须放大或缩小),不必太花时间,但如果是45°全视角的画面,就需要转换坐标值。">
    <meta name="keywords" content="角色扮演 教程">
    <meta name="generator" content="PKBook">
    <link rel="stylesheet" href="https://naka1205.github.io/rpgsample/assets/css/style.css">
    <link rel="stylesheet" href="https://naka1205.github.io/rpgsample/assets/css/search.css">
    <link rel="stylesheet" href="https://naka1205.github.io/rpgsample/assets/css/ebook.css">
    <link rel="stylesheet" href="https://naka1205.github.io/rpgsample/assets/css/website.css">
    <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/styles/github.min.css" rel="stylesheet">
    <meta name="HandheldFriendly" content="true" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://naka1205.github.io/rpgsample/assets/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="https://naka1205.github.io/rpgsample/assets/images/favicon.ico" type="image/x-icon">
</head>
<body>
<div class="book">
    <div class="book-summary">
        <div id="book-search-input" role="search">
            <input type="text" placeholder="输入关键词搜索" />
        </div>
        <nav role="navigation">
    <ul class="summary">
        <li><a href="https://naka1205.github.io/rpgsample/index.html" target="blank" class="header">说明</a></li>
        <li class="divider"></li>
                <li class="header">写一个角色扮演游戏</li>
                        <li class="chapter " data-level="1.1" data-path="https://naka1205.github.io/rpgsample/p/FEEC8D8FB78C0C58.html"><a href="https://naka1205.github.io/rpgsample/p/FEEC8D8FB78C0C58.html">何谓角色扮演游戏（RPG）</a></li>
                        <li class="chapter " data-level="1.2" data-path="https://naka1205.github.io/rpgsample/p/BC79B4D3134C347C.html"><a href="https://naka1205.github.io/rpgsample/p/BC79B4D3134C347C.html">RPG分类</a></li>
                        <li class="chapter " data-level="1.3" data-path="https://naka1205.github.io/rpgsample/p/F20DC96FA50A49C7.html"><a href="https://naka1205.github.io/rpgsample/p/F20DC96FA50A49C7.html">写RPG时的软硬件需求</a></li>
                    <li class="divider"></li>
                <li class="header">游戏系统的设计</li>
                        <li class="chapter " data-level="2.1" data-path="https://naka1205.github.io/rpgsample/p/057DE479BA15F0C2.html"><a href="https://naka1205.github.io/rpgsample/p/057DE479BA15F0C2.html">RPG系统</a></li>
                        <li class="chapter " data-level="2.2" data-path="https://naka1205.github.io/rpgsample/p/98A9BEB4C06AB6F5.html"><a href="https://naka1205.github.io/rpgsample/p/98A9BEB4C06AB6F5.html">RPG的必备功能和设计</a></li>
                    <li class="divider"></li>
                <li class="header">Windows程序设计</li>
                        <li class="chapter " data-level="3.1" data-path="https://naka1205.github.io/rpgsample/p/29DEF3B121E67E34.html"><a href="https://naka1205.github.io/rpgsample/p/29DEF3B121E67E34.html">游戏的必备功能</a></li>
                        <li class="chapter " data-level="3.2" data-path="https://naka1205.github.io/rpgsample/p/E250E5C20EC8FDF3.html"><a href="https://naka1205.github.io/rpgsample/p/E250E5C20EC8FDF3.html">开启窗口</a></li>
                        <li class="chapter " data-level="3.3" data-path="https://naka1205.github.io/rpgsample/p/7FA5E0693CC56877.html"><a href="https://naka1205.github.io/rpgsample/p/7FA5E0693CC56877.html">显示CG</a></li>
                        <li class="chapter " data-level="3.4" data-path="https://naka1205.github.io/rpgsample/p/FF11E655570F0335.html"><a href="https://naka1205.github.io/rpgsample/p/FF11E655570F0335.html">显示CG的应用软件</a></li>
                        <li class="chapter " data-level="3.5" data-path="https://naka1205.github.io/rpgsample/p/FD772D011D420B30.html"><a href="https://naka1205.github.io/rpgsample/p/FD772D011D420B30.html">CG/Sprite的重叠显示</a></li>
                        <li class="chapter " data-level="3.6" data-path="https://naka1205.github.io/rpgsample/p/9505172717587147.html"><a href="https://naka1205.github.io/rpgsample/p/9505172717587147.html">贴图零件(sprite)显示</a></li>
                    <li class="divider"></li>
                <li class="header">显示地图和人物</li>
                        <li class="chapter  active " data-level="4.1" data-path="https://naka1205.github.io/rpgsample/p/D669497E6697FA89.html"><a href="https://naka1205.github.io/rpgsample/p/D669497E6697FA89.html">地图坐标系</a></li>
                        <li class="chapter " data-level="4.2" data-path="https://naka1205.github.io/rpgsample/p/CB9C77BD644B1669.html"><a href="https://naka1205.github.io/rpgsample/p/CB9C77BD644B1669.html">Sprite的显示</a></li>
                        <li class="chapter " data-level="4.3" data-path="https://naka1205.github.io/rpgsample/p/D4F60F30B7F0944A.html"><a href="https://naka1205.github.io/rpgsample/p/D4F60F30B7F0944A.html">显示的程序实例</a></li>
                    <li class="divider"></li>
                <li class="header">人物移动</li>
                        <li class="chapter " data-level="5.1" data-path="https://naka1205.github.io/rpgsample/p/9BDC29F23C108FCD.html"><a href="https://naka1205.github.io/rpgsample/p/9BDC29F23C108FCD.html">移动的思维方式</a></li>
                        <li class="chapter " data-level="5.2" data-path="https://naka1205.github.io/rpgsample/p/294F9E27361163C8.html"><a href="https://naka1205.github.io/rpgsample/p/294F9E27361163C8.html">移动的动画</a></li>
                        <li class="chapter " data-level="5.3" data-path="https://naka1205.github.io/rpgsample/p/850A8F5D7D49913A.html"><a href="https://naka1205.github.io/rpgsample/p/850A8F5D7D49913A.html">移动的程序实例</a></li>
                    <li class="divider"></li>
                <li class="header">战斗</li>
                        <li class="chapter " data-level="6.1" data-path="https://naka1205.github.io/rpgsample/p/714FCCE62BEAE7EF.html"><a href="https://naka1205.github.io/rpgsample/p/714FCCE62BEAE7EF.html">读入地图数据</a></li>
                        <li class="chapter " data-level="6.2" data-path="https://naka1205.github.io/rpgsample/p/DE18A13DD466BCF5.html"><a href="https://naka1205.github.io/rpgsample/p/DE18A13DD466BCF5.html">战斗规则</a></li>
                        <li class="chapter " data-level="6.3" data-path="https://naka1205.github.io/rpgsample/p/372F73F2A1CBD002.html"><a href="https://naka1205.github.io/rpgsample/p/372F73F2A1CBD002.html">攻击时的动画</a></li>
                        <li class="chapter " data-level="6.4" data-path="https://naka1205.github.io/rpgsample/p/D6377D95C3DAE065.html"><a href="https://naka1205.github.io/rpgsample/p/D6377D95C3DAE065.html">魔法攻击的处理</a></li>
                        <li class="chapter " data-level="6.5" data-path="https://naka1205.github.io/rpgsample/p/84AF096B75C4D0F4.html"><a href="https://naka1205.github.io/rpgsample/p/84AF096B75C4D0F4.html">CPU端的思维模式</a></li>
                        <li class="chapter " data-level="6.6" data-path="https://naka1205.github.io/rpgsample/p/ECD1A205E33A1347.html"><a href="https://naka1205.github.io/rpgsample/p/ECD1A205E33A1347.html">CPU端人物的攻击</a></li>
                        <li class="chapter " data-level="6.7" data-path="https://naka1205.github.io/rpgsample/p/FAC327CB74DDD86D.html"><a href="https://naka1205.github.io/rpgsample/p/FAC327CB74DDD86D.html">执行程序实例</a></li>
                    <li class="divider"></li>
                <li><a href="https://github.com/naka1205/pkbook" target="blank" class="gitbook-link">Published with PKBook</a></li>
    </ul>
</nav>
    </div>
    
    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
                <h1><i class="fa fa-circle-o-notch fa-spin"></i><a href="https://naka1205.github.io/rpgsample/p/D669497E6697FA89.html">地图坐标系</a></h1>
            </div>
            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                    <div id="book-search-results">
                        <div class="search-noresults">
                            <section class="normal markdown-section">
                                <h3 id="%E5%9C%B0%E5%9B%BE%E5%9D%90%E6%A0%87%E7%B3%BB" name="%E5%9C%B0%E5%9B%BE%E5%9D%90%E6%A0%87%E7%B3%BB">地图坐标系</h3>
<p>必须先有一个坐标系,才能显示地图或人物。</p>
<p>如果使用的地图是垂直向下看的方格地图,画面显示的坐标系即同地图的坐标系(只须放大或缩小),不必太花时间,但如果是45°全视角的画面,就需要转换坐标值。</p>
<p>不先处理好坐标转换的问题,甚至会无法做移动测试,所以我们就先从这里开始解起吧。</p>
<p>45°全视角的坐标系即如图4-1所示。</p>
<h4 id="%E4%BB%8E%E5%9C%B0%E5%9B%BE%E5%9D%90%E6%A0%87%E8%BD%AC%E6%8D%A2%E6%88%90%E7%94%BB%E9%9D%A2%E5%9D%90%E6%A0%87" name="%E4%BB%8E%E5%9C%B0%E5%9B%BE%E5%9D%90%E6%A0%87%E8%BD%AC%E6%8D%A2%E6%88%90%E7%94%BB%E9%9D%A2%E5%9D%90%E6%A0%87">从地图坐标转换成画面坐标</h4>
<p>我们先想想从地图坐标转换成画面坐标时的转换式。转换成画面坐标时,就已经从“点”变成“方格”,所以要求出框住菱形外围的矩形的“左上角”坐标,如图4-2所示。</p>
<p>框住菱形外围的矩形大小是“64×32”,而在640×480的画面(程序区域)上则可显示10×10的地图。因为方格间有互相重叠,所以画面坐标的最小单位是这个尺寸大小的1/2(长X宽=16×32),如图4-3所示。</p>
<p>这时候,可以先用一个比较容易算的数值试算看看。最容易算的数值当然是“0”。地图坐标为“0,0,则画面坐标为“X=0”,Y坐标则偏移6个方格(最小单位:12),如图4-4所示。故可得出下列公式:</p>
<p>地图X坐标(map_X)每增加1,画面Y坐标(viewY)就会相对减少1。也就是说:</p>
<pre><code>view_x=map_x"(MAPGRID_WIDTH/2)
iew_y=(12-map_x)*(MAPGRID_HEIGHT/2)</code></pre>
<p>而地图Y坐标(map_Y)每增加1,画面X坐标(view_XY)也同样增加1。</p>
<pre><code>view_x=000000ap_x+map_y)*(MAPGRID_WIDTH/2)
view_y=(12-map_x+map_y)*(MAPGRID_HEIGHT/2)</code></pre>
<p>地图坐标和画面坐标两者的转换公式即如上所示。</p>
<h4 id="%E4%BB%8E%E7%94%BB%E9%9D%A2%E5%9D%90%E6%A0%87%E8%BD%AC%E6%8D%A2%E6%88%90%E5%9C%B0%E5%9B%BE%E5%9D%90%E6%A0%87" name="%E4%BB%8E%E7%94%BB%E9%9D%A2%E5%9D%90%E6%A0%87%E8%BD%AC%E6%8D%A2%E6%88%90%E5%9C%B0%E5%9B%BE%E5%9D%90%E6%A0%87">从画面坐标转换成地图坐标</h4>
<p>反过来的话,要如何从画面坐标求出地图坐标?</p>
<p>公式转换的计算单位是像素,不过像素坐标都是整数,如果求出的结果不是整数时还是会强迫改成整数。因此计算结果可能会有1像素的误差(这是无条件进位或无条件舍去时所产生的误差,所以或许可以视为一定会有误差)。</p>
<h5 id="%E5%88%A9%E7%94%A8%E6%B8%90%E5%8F%98%E8%89%B2%E5%9C%B0%E5%9B%BE" name="%E5%88%A9%E7%94%A8%E6%B8%90%E5%8F%98%E8%89%B2%E5%9C%B0%E5%9B%BE">利用渐变色地图</h5>
<p>先在内存上做一个“渐变色地图”搭配使用也是一种方法,如图4-5所示。</p>
<p>这种方法的优点是能适用于各种不同形状的地图。受限于印刷问题,虽然上图使用黑白两色,实际上X坐标用红色、Y坐标用蓝色会更容易判断坐标位置。</p>
<p>因为这里的目的只是为了“用鼠标指出”,并不需要太严格要求,所以先用计算式就好了。有关渐变色地图的部分,在Chapter9的“直接跳跃(directjump)”还有详细介绍,有兴趣的读者可以先翻过去参考看看。</p>
<h5 id="%E5%9D%90%E6%A0%87%E8%BD%AC%E6%8D%A2%E7%9A%84%E8%AE%A1%E7%AE%97%E5%BC%8F" name="%E5%9D%90%E6%A0%87%E8%BD%AC%E6%8D%A2%E7%9A%84%E8%AE%A1%E7%AE%97%E5%BC%8F">坐标转换的计算式</h5>
<p>首先,方格的长宽比例是“2:1”,所以画面Y坐标要放大2倍。然后地图坐标也要从方格单位改成像素单位,即地图坐标乘以64倍,0~63为“0”、64~127为“1”……以此类推(因为画面坐标是以像素为计算单位)。</p>
<p>试求画面坐标“0,0”时的地图坐标。地图Y坐标跟画面坐标总共偏移了6.5个方格,所以要把偏移的部分改正回来。</p>
<pre><code>view_y=MAPGRIDHEIGHT*13/2;</code></pre>
<p>因为这是整数运算,所以要写成13/2而非6.5。接着,再把Y坐标放大2倍。</p>
<pre><code>view_y*=2;</code></pre>
<p>最后再套用地图坐标转换成画面坐标时的模式,即可得到下列公式:</p>
<pre><code>map_x=(view_x-view_y)/MAPGRID_WIDTH
map_y=(view_x+view_y)/MAPGRID_WIDTH</code></pre>
<p>诈看之下,这个公式似乎符合基本的数学逻辑,但是里面隐藏着bug!</p>
<p>地图坐标转换成画面坐标时的计算都在地图坐标的范围之内,所以公式运算不会有问题,但从画面坐标转换成地图坐标时却需要考虑到“不在范围之内”的部分。“不在范围之内”是指在画面上(窗口内)、但未显示菱形方格(地图)的部分。</p>
<p>不在范围之内的坐标值可能会让“viewx-viewy”或“viewx+viewy”变成负数。这里本来就是整数运算,故计算结果如图4-6所示,0的长度会明显比其他数字长。</p>
<p>如此来,当结果出现负数时就会偏移1个方格,也没办法直接两数相除。各位可以参考以下几种解决方法。</p>
<h5 id="%E8%A7%A3%E6%B3%95%281%29%3A%E5%AE%9E%E6%95%B0%E8%BF%90%E7%AE%97" name="%E8%A7%A3%E6%B3%95%281%29%3A%E5%AE%9E%E6%95%B0%E8%BF%90%E7%AE%97">解法(1):实数运算</h5>
<p>如果问题是出在整数运算,改用实数运算就可以解决问题。实数运算(浮点小数运算)可以使用“floor”函数。利用floor函数就能得到预期中的数值(“floor(x)”会传回表示【以下的最大整数】的浮点小数值)。
应用floor的公式即为:</p>
<pre><code>map_x=int(floor(double(view_x-view_y)/MAPGRID_WIDTH
map_y=int(floor(double(view_x+view_y)/MAPGRID_WIDTH</code></pre>
<h5 id="%E8%A7%A3%E6%B3%95%282%29%3A%E5%BA%94%E7%94%A8%E7%A7%BB%E4%BD%8D%28shift%29" name="%E8%A7%A3%E6%B3%95%282%29%3A%E5%BA%94%E7%94%A8%E7%A7%BB%E4%BD%8D%28shift%29">解法(2):应用移位(shift)</h5>
<p>即使直接做整数运算,有时不用除法改用移位(shift)反而能得到预期中的数值。应用移位的公式即为:</p>
<pre><code>map_x=(view_x-view_y)&gt;&gt;6
map_y=(view_x+view_y)&gt;&gt;6</code></pre>
<p>移位分成“算术移位(Shiftarithmetic)”和“逻辑移位(Shiftlogical)"两种。</p>
<p>利用算术移位可以得到想要的结果,但逻辑移位会让负数变成很大的正数。其实就算变成再大的正数,都还是“不在范围之内”,所以不成问题。</p>
<p>不过,移位只能利用在2的乘暴计算(2、4、8、16..)而已,用途比较有限(因为本书的程序实例是把地图坐标放大成64倍,故可使用移位)。</p>
<h5 id="%E8%A7%A3%E6%B3%95%283%29%3A%E5%8A%A0%E4%B8%8Aoffset%28%E4%BD%8D%E7%A7%BB%E5%81%8F%E5%B7%AE%29" name="%E8%A7%A3%E6%B3%95%283%29%3A%E5%8A%A0%E4%B8%8Aoffset%28%E4%BD%8D%E7%A7%BB%E5%81%8F%E5%B7%AE%29">解法(3):加上offset(位移偏差)</h5>
<p>为计算中出现负数才会发生问题,那把计算范围限制为正数就OK啦。</p>
<pre><code>map_x=(view_x-view_y+MAPGRID_WIDTH*10)/MAPGRID_WIDTH-10
map_y=(view_x+view_y+MAPGRID_WIDTH*10)/MAPGRID_WIDTH-10</code></pre>
<p>如果偏移的方格数日高达10个,确实就不在范围之内。只要事先加上适当数值,等到除算后再减去该数值即可(若不在范围之内实不需要正确数值,则offset值可设为“1”。offset值为1时,-1的范围会变大,但-1已经不在范围之内,所以没关系。)</p>
<h5 id="%E8%A7%A3%E6%B3%95%284%29%3A%E5%88%86%E7%B1%BB%E5%A4%84%E7%90%86" name="%E8%A7%A3%E6%B3%95%284%29%3A%E5%88%86%E7%B1%BB%E5%A4%84%E7%90%86">解法(4):分类处理</h5>
<p>利用计叙述分成负数、正数两种不同情形该如何进行计算,即可得到正确的计算结果。</p>
<p>不过,最近的CPU不太擅长处理条件分支,而且一进入条件分支之后来源代码的“流向”就会被分开,降低整个程序的可阅读性。相信有不少读者最先想到的就是“分类处理”,但很多时候不一定非用分类处理的做法不可,建议多动动脑想些其他的做法。</p>                            </section>
                        </div>
                        <div class="search-results">
                            <div class="has-results">
                                <h1 class="search-results-title">
                                    关于"<span class='search-query'></span>"的搜索结果共<span class='search-results-count'></span>条
                                </h1>
                                <ul class="search-results-list"></ul>
                            </div>
                            <div class="no-results">
                                <h1 class="search-results-title">没有"<span class='search-query'></span>"相关内容</h1>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                <a href="https://naka1205.github.io/rpgsample/p/9505172717587147.html" class="navigation navigation-prev " aria-label="贴图零件(sprite)显示">
            <i class="fa fa-angle-left"></i>
        </a>
                <a href="https://naka1205.github.io/rpgsample/p/CB9C77BD644B1669.html" class="navigation navigation-next " aria-label="Sprite的显示">
            <i class="fa fa-angle-right"></i>
        </a>
               
    </div>
<script>
var gitbook = gitbook || [];
gitbook.push(function() {
    gitbook.page.hasChanged({
        "page": {
            "title":  "地图坐标系",
            "next": {
                "title": "Sprite的显示"
            },
            "previous": {
                "title": "贴图零件(sprite)显示"
            }
        },
        "config": {
            "gitbook": "*",
            "theme": "default",
            "variables": {},
            "plugins": ["-lunr", "-search", "-highlight","search-pro"],
            "pluginsConfig": {
                "search-pro": {},
                "highlight": {},
                "sharing": {},
                "fontsettings": {},
                "theme-default": {}
            },
            "structure": {},
            "pdf": {},
            "styles": {}
        },
        "file": {},
        "gitbook": {},
        "basePath": "https://naka1205.github.io/rpgsample",
        "book": {}
    });
});
</script>
</div>
<script src="https://naka1205.github.io/rpgsample/assets/js/gitbook.js"></script>
<script src="https://naka1205.github.io/rpgsample/assets/js/theme.js"></script>
<script src="https://naka1205.github.io/rpgsample/assets/js/jquery.mark.min.js"></script>
<script src="https://naka1205.github.io/rpgsample/assets/js/search.js"></script>
<script src="https://naka1205.github.io/rpgsample/assets/js/buttons.js"></script>
<script src="https://naka1205.github.io/rpgsample/assets/js/fontsettings.js"></script>
<script src="https://naka1205.github.io/rpgsample/assets/js/plugin.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/highlight.min.js"></script>
</body>
</html>